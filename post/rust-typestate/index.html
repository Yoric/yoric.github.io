<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="en">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="https://yoric.github.io/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:url" content="https://yoric.github.io/post/rust-typestate/">
  <meta property="og:site_name" content="Il y a du thé renversé au bord de la table !">
  <meta property="og:title" content="Typestates in Rust">
  <meta property="og:description" content="A long time ago, the Rust language was a language with typestate. Officially, typestates were dropped long before Rust 1.0. In this entry, I’ll get you in on the worst kept secret of the Rust community: Rust still has typestates.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2018-02-22T15:15:55+01:00">
    <meta property="article:modified_time" content="2018-03-22T10:00:55+01:00">
    <meta property="article:tag" content="Rust">
    <meta property="article:tag" content="Programming Languages">
    <meta property="article:tag" content="Types">
<title>Typestates in Rust</title>

    <link rel="canonical" href="https://yoric.github.io/post/rust-typestate/">

    <link rel="stylesheet" href="https://yoric.github.io/css/global.css">

    <link rel="stylesheet" href="https://yoric.github.io/css/custom.css">

    <link rel="stylesheet" href="https://yoric.github.io/css/search.css" />

    
    

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="https://yoric.github.io/ " class="nav-title">Il y a du thé renversé au bord de la table !</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="https://yoric.github.io/post " class="nav-item-content">Articles</a>
          </div><div class="nav-item-wrapper">
            <a href="https://yoric.github.io/about" class="nav-item-content">About</a>
          </div><div class="nav-item-wrapper">
            <a href="https://yoric.github.io/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yoric.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        Rust
                      
                    
                  </span>
                  <span class="category-eyebrow__date">February 22, 2018</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">Typestates in Rust</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="https://yoric.github.io/tags/rust" class="tag">
                    Rust
                  </a>
                
                  
                  <a href="https://yoric.github.io/tags/programming-languages" class="tag">
                    programming languages
                  </a>
                
                  
                  <a href="https://yoric.github.io/tags/types" class="tag">
                    types
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            <p class="component-content component">A long time ago, the Rust language was a language with typestate. Officially, typestates were dropped long before Rust 1.0. In this entry, I’ll get you in on the worst kept secret of the Rust community: Rust still has typestates.</p>

<div class="component-content pagebody component">
  <h1 id="wait-whats-a-typestate" class="pagebody-header">
    Wait, what’s a typestate?
  </h1>
</div><p class="component-content component">Consider an object representing a file – let’s call that data structure a <code>MyFile</code>. Before a <code>MyFile</code> is opened, it cannot be read. Once a <code>MyFile</code> is closed, it cannot be read. In between, the file can be read. Typestates are a mechanism to let the type-checker check that you’re not making the following mistakes:</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">read_contents_of_file</span>(path: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Path</span>) -&gt; String {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> my_file <span style="color:#f92672">=</span> MyFile::new(path);
</span></span><span style="display:flex;"><span>  my_file.open();  <span style="color:#75715e">// Error: this may fail.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> my_file.read_all(); <span style="color:#75715e">// Invalid if `my_file.open()` failed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  my_file.close();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  my_file.seek(Seek::Start); <span style="color:#75715e">// Error: we have closed `my_file`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  result
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">In this example, we have made two mistakes:</p>
<div class="component-content component"><ol>
<li>we have read a file that may not have been opened;</li>
<li>we have seeked in a file that was already closed.</li>
</ol></div>
<p class="component-content component">In most programming languages, we can easily design the API
of <code>MyFile</code> to ensure that the first error is impossible,
simply by throwing an exception when the file fails to open.
Some standard libraries and frameworks decide to not follow
this principle for the sake of flexibility, but the capability
exists in the language itself.</p>
<p class="component-content component">The second error, however, is much harder to catch. Most
programming languages support the necessary features to
make this error hard, typically by closing the file upon
destruction or at the end of a higher-order function call,
but the only non-academic language that I know of that
can actually entirely prevent that error is Rust.</p>

<div class="component-content pagebody component">
  <h1 id="trivial-typestates-in-rust" class="pagebody-header">
    Trivial typestates in Rust
  </h1>
</div><p class="component-content component">How do we do this in Rust?</p>
<p class="component-content component">Well, the simplest way to do it is to introduce sane types
for our operations on <code>MyFile</code>:</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> MyFile {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// `open` is the only way of constructing an instance of `MyFile`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">open</span>(path: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Path</span>) -&gt; Result<span style="color:#f92672">&lt;</span>MyFile, Error<span style="color:#f92672">&gt;</span> { <span style="color:#f92672">..</span>. }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// `seek` requires an instance of `MyFile`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">seek</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, pos: <span style="color:#a6e22e">Seek</span>) -&gt; Result<span style="color:#f92672">&lt;</span>(), Error<span style="color:#f92672">&gt;</span> { <span style="color:#f92672">..</span>. }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// `read_all` requires an instance of `MyFile`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">read_all</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>String, Error<span style="color:#f92672">&gt;</span> { <span style="color:#f92672">..</span>. }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// `close` takes an argument `self`, not `&amp;self` or `&amp;mut self`,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// which means that it *moves* its object, effectively
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// consuming it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">close</span>(self) -&gt; Result<span style="color:#f92672">&lt;</span>(), Error<span style="color:#f92672">&gt;</span> { <span style="color:#f92672">..</span>. }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Drop <span style="color:#66d9ef">for</span> MyFile {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Introduce a destructor to auto-close an instance of `MyFile`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// if we haven&#39;t closed it yet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">drop</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) { <span style="color:#f92672">..</span>. }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">Let&rsquo;s rewrite our above example:</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">read_contents_of_file</span>(path: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Path</span>) -&gt; Result<span style="color:#f92672">&lt;</span>String, Error<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> my_file <span style="color:#f92672">=</span> MyFile::open(path)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Note the `?` above. It&#39;s a simple operator that asks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// the compiler to check whether the operation succeeded.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// The *only* way to obtain a `MyFile` object is to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// have a successful `MyFile::open`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// At this line, `my_file` is a `MyFile`, which means
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// that we may use it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> my_file.read_all()<span style="color:#f92672">?</span>; <span style="color:#75715e">// Valid.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  my_file.close(); <span style="color:#75715e">// Valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Since `my_file.close()` consumed `my_file`,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// this variable doesn&#39;t exist anymore.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  my_file.seek(Seek::Start)<span style="color:#f92672">?</span>; <span style="color:#75715e">// Error, detected by the compiler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  result
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">This works even in more complex cases:</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">read_contents_of_file</span>(path: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Path</span>) -&gt; Result<span style="color:#f92672">&lt;</span>String, Error<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// As above.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> my_file <span style="color:#f92672">=</span> MyFile::open(path)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> my_file.read_all()<span style="color:#f92672">?</span>; <span style="color:#75715e">// Valid.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> are_we_happy_yet() {
</span></span><span style="display:flex;"><span>      my_file.close(); <span style="color:#75715e">// Valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Since `my_file.close()` consumed `my_file`,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// this variable doesn&#39;t exist anymore in at least
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// one execution path.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  my_file.seek(Seek::Start)<span style="color:#f92672">?</span>; <span style="color:#75715e">// Error, detected by the compiler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If we haven&#39;t closed `my_file`, the destructor will close
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// it now.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">The key here is that the Rust type system enforces the fact
that a variable may not be used after having been <strong>moved</strong>.
In our case, <code>my_file.close()</code> moved the value, effectively
consuming it.</p>
<p class="component-content component">Even if we had attempted to hide the variable somewhere
else, and reuse it after the call to <code>my_file.close()</code>,
we would have been thwarted by the compiler:</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">read_contents_of_file</span>(path: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Path</span>) -&gt; Result<span style="color:#f92672">&lt;</span>String, Error<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// As above.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> my_file <span style="color:#f92672">=</span> MyFile::open(path)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> my_file.read_all()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> my_file_sneaky_backup <span style="color:#f92672">=</span> my_file;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Here, we have moved `my_file` to `my_file_sneaky_backup`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// So we cannot use `my_file` anymore.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  my_file.close(); <span style="color:#75715e">// Error, detected by the compiler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  my_file_sneaky_backup.seek(Seek::Start)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>  result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If we haven&#39;t closed `my_file`, the destructor will close
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// it now.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">Let&rsquo;s try another way to cheat the compiler by making
the file accessible after it has been closed:</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">read_contents_of_file</span>(path: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Path</span>) -&gt; Result<span style="color:#f92672">&lt;</span>String, Error<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> my_shared_file <span style="color:#f92672">=</span> Rc::new(RefCell::new(MyFile::open(path)<span style="color:#f92672">?</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Here, `my_shared_file` is a shared pointer to a mutable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// instance of `MyFile`, pretty much as a regular
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// reference in Java, C# or Python.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> my_shared_file.borrow_mut()
</span></span><span style="display:flex;"><span>    .read_all()<span style="color:#f92672">?</span>; <span style="color:#75715e">// Valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> my_shared_file_sneaky_backup <span style="color:#f92672">=</span> my_shared_file.clone();
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// We have cloned the pointer, creating a second manner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// of accessing `my_shared_file`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Let&#39;s make sure that we can use both the backup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// and the orignal file:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  my_shared_file_sneaky_backup.seek(Seek::Start)<span style="color:#f92672">?</span>; <span style="color:#75715e">// Valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  my_shared_file.seek(Seek::Start)<span style="color:#f92672">?</span>; <span style="color:#75715e">// Also valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Ahah, now we can surely close `my_shared_file`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// then manipulate `my_shared_file_sneaky_backup`,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// as we would in Java, C# or Python!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Except we can&#39;t call `my_shared_file.close()`,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// because the underlying `MyFile` is shared,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// which means that nobody can *move* it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  my_shared_file.close(); <span style="color:#75715e">// Error, detected by the compiler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  my_shared_file_sneaky_backup.seek(Seek::Start)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>  result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// If we haven&#39;t closed `my_file`, the destructor will close
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// it now.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">Again, we have been thwarted by the compiler. Indeed, short
of explicitly going into <code>unsafe</code> mode, we will not be able
to break the invariant that <code>seek</code> cannot be used after <code>close</code>.</p>
<p class="component-content component">This example demonstrated the first brick of type states in
Rust: the <strong>typed move operation</strong>. So far, so good. But we are
only dealing with a trivial case, in which files only have two
states: <strong>opened</strong> and <strong>closed</strong>.</p>
<p class="component-content component">Let&rsquo;s see if we can handle more complex cases.</p>

<div class="component-content pagebody component">
  <h1 id="complex-typestates" class="pagebody-header">
    Complex typestates
  </h1>
</div><p class="component-content component">Instead of files, let us now consider the following (and admittedly pretty dumb)
network protocol:</p>
<div class="component-content component"><ol>
<li>Sender sends message &ldquo;HELLO&rdquo;.</li>
<li>Receiver receives message &ldquo;HELLO&rdquo;, responds with message &ldquo;HELLO, YOU&rdquo;.</li>
<li>Sender receives message &ldquo;HELLO, YOU&rdquo;, responds with random number.</li>
<li>Receiver receives number from sender, responds with the same number.</li>
<li>Sender receives same number from receiver, responds &ldquo;BYE&rdquo;.</li>
<li>Receiver receives &ldquo;BYE&rdquo; from sender, responds &ldquo;BYE, YOU&rdquo;.</li>
<li>Return to 1.</li>
</ol></div>
<p class="component-content component">Any other message is ignored.</p>
<p class="component-content component">We can design our <code>Sender</code> (and similarly, <code>Receiver</code>) to
ensure that operations proceed in the right order. For
the moment, we don&rsquo;t care about identifying the
correspondant or the number.</p>
<p class="component-content component">For this purpose, we&rsquo;ll combine the <strong>typed moves</strong>
with another technique, well known to strongly-typed
functional programmers, known as <strong>phantom types</strong>.</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// A series of 0-sized types representing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// the state of the sender. The value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// is not important, only the type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// (hence the name &#34;phantom type&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SenderReadyToSendHello</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SenderHasSentHello</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SenderHasSentNumber</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SenderHasReceivedNumber</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Sender</span><span style="color:#f92672">&lt;</span>S<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">/// Actual implementation of network I/O.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>  inner: <span style="color:#a6e22e">SenderImpl</span>;  
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">/// 0-sized field, doesn&#39;t exist at runtime.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>  state: <span style="color:#a6e22e">S</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// The following methods may be called regardless of the state.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>S<span style="color:#f92672">&gt;</span> Sender<span style="color:#f92672">&lt;</span>S<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The port used to connect the sender.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">port</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">usize</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Close the sender, once and for all.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">close</span>(self);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// The following method may be called only in a state SenderReadyToSendHello.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">impl</span> Sender<span style="color:#f92672">&lt;</span>SenderReadyToSendHello<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Send hello.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// This method consumes the sender in its current state,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// returns it in a new state.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">send_hello</span>(<span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#a6e22e">Sender</span><span style="color:#f92672">&lt;</span>SenderHasSentHello<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.inner.send_message(<span style="color:#e6db74">&#34;HELLO&#34;</span>);
</span></span><span style="display:flex;"><span>        Sender {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">/// Move the implementation of network I/O.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>            <span style="color:#e6db74">/// The compiler is typically smart enough
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>            <span style="color:#e6db74">/// to realize that this requires no runtime
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>            <span style="color:#e6db74">/// operation.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>            inner: <span style="color:#a6e22e">self</span>.inner,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">/// Replace the 0-sized field.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>            <span style="color:#e6db74">/// This operation is erased at runtime.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>            state: <span style="color:#a6e22e">SenderHasSentHello</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// The following method may be called only in a state SenderHasSentHello.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">impl</span> Sender<span style="color:#f92672">&lt;</span>SenderHasSentHello<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Wait until the receiver has sent &#34;HELLO, YOU&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// respond with number.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Return the sender in state `SenderHasSentNumber`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">wait_respond_to_hello_you</span>(<span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#a6e22e">Sender</span><span style="color:#f92672">&lt;</span>SenderHasSentNumber<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// If the receiver has sent &#34;HELLO, YOU&#34;, respond with number and
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// return the sender in state `SenderHasSentNumber`.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Otherwise, return the unchanged state.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_respond_to_hello_you</span>(<span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>Sender<span style="color:#f92672">&lt;</span>SenderHasSentNumber<span style="color:#f92672">&gt;</span>, Self<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// The following method may be called only in a state SenderHasSentNumber.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">impl</span> Sender<span style="color:#f92672">&lt;</span>SenderHasSentNumber<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Wait until the receiver has sent number, respond &#34;BYE&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Return the sender in state `SenderReadyToSendHello`
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">wait_respond_to_hello_you</span>(<span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#a6e22e">Sender</span><span style="color:#f92672">&lt;</span>SenderReadyToSendHello<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// If the receiver has sent number, respond and return the sender
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// in state `SenderReadyToSendHello`.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">///
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Otherwise, return the unchanged state.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">try_respond_to_hello_you</span>(<span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>Sender<span style="color:#f92672">&lt;</span>SenderReadyToSendHello<span style="color:#f92672">&gt;</span>, Self<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">With this design, it is clear that the <code>Sender</code> can only follow the protocol:</p>
<div class="component-content component"><ul>
<li>from step 1 (<code>SenderReadyToSendHello</code>, it may only go to step 3);</li>
<li>from step 3 (<code>SenderHasSentHello</code>, it may only stay in step 3 or go to step 5);</li>
<li>from step 5 (<code>SenderHasSentNumber</code>, it may only stay in step 5 or go back to step 1).</li>
</ul></div>
<p class="component-content component">Any attempt to detract from the protocol will be blocked by the type system.</p>
<p class="component-content component">If you ever need to work with network protocols, device drivers,
industrial devices with specific safety instructions or OpenGL/DirectX/anything
else that requires you to perform complex interactions with the hardware,
you&rsquo;ll probably be happy to have such guarantees!</p>
<p class="component-content component">Welcome to the world of type states.</p>

<div class="component-content pagebody component">
  <h1 id="quick-note-beyond-type-states" class="pagebody-header">
    Quick note: beyond type states
  </h1>
</div><p class="component-content component">By the way, to continue on our network example,
what if we wanted to, say, store the number sent by the <code>Server</code> to
check that the response matched? Well, to do this, we can simply
store the number on <code>SenderHasSentNumber</code>:</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SenderHasSentNumber</span> {
</span></span><span style="display:flex;"><span>    number_sent: <span style="color:#66d9ef">u32</span>,
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">Once again, the compiler will check that the code only accesses <code>number_sent</code>
when the sender is in state <code>SenderHasSentNumber</code>.</p>
<p class="component-content component">We will lose a (tiny) amount of performance, we the compiler won&rsquo;t be able to
optimize the transformation of the <code>Sender</code> between identical representations,
but that&rsquo;s generally worth it.</p>

<div class="component-content pagebody component">
  <h1 id="closing-words" class="pagebody-header">
    Closing words
  </h1>
</div><p class="component-content component">I hope that this quick demonstration has convinced you that the power of Rust
<strong>typed move</strong>, combined with <strong>phantom types</strong>,
is a great tool to ensure the safety of your code. It is used
all around the Rust standard libraries and many well-designed third-party
libraries.</p>
<p class="component-content component">For the moment, I am not aware of any other programming language with typed
move semantics (note: C++ has <em>untyped</em> move semantics), but I imagine that
other languages will eventually imitate Rust if this feature proves to be
well-liked. I, for one, couldn&rsquo;t do without :)</p>
<p class="component-content component"><strong>edit</strong> As remarked by Thomas Bracht Laumann Jespersen, a variant of
this method can also be used to encode session types in Rust. I&rsquo;ll
let you look at the <a href="https://github.com/Munksgaard/session-types">library</a>
and the <a href="http://munksgaard.me/papers/laumann-munksgaard-larsen.pdf">paper</a> for more details!</p>
          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  Copyright: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">Author:  David Teller </p>
                <p class="content">Posted on:  February 22, 2018</p>
              </div>
            </div>
          </div></article>
      </section>
      
      <div id="gitalk-container"></div>
      GITALK ENABLED
      <script>
        const gitalk = new Gitalk({
          clientID: 'be349d0bd8338cd1aa1d',
          clientSecret: '6190d06de070bfa3ed050a29390a4ccd77ba032a',
          repo: 'yoric.github.io',    
          owner: 'Yoric',
          admin: ['Yoric'],
          id: 'df130991b0a411fc17a6dc6ba8d4eb99',  
          distractionFreeMode: false  
        })

        gitalk.render('gitalk-container')
      </script>
      
    </main>

  <script>
    var script = document.createElement("script");script.src = "https://yoric.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:D.O.MyLastName@gmail.com">D.O.MyLastName@gmail.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">Social Media</div>
            
              <a href="http://github.com/Yoric" target="_blank">github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">Related</div>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2024
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
